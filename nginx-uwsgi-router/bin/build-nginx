#!/bin/bash

set -e

. env.properties


if [ -e "$NGINX_PREFIX" ]; then
    exit 0
fi

prefix="${NGINX_PREFIX%/}"
version="nginx-${NGINX_VERSION}"
module_root="$(cd ../etc/nginx; pwd)"


archive="${version}.tar.gz"
url="http://nginx.org/download/${archive}"

rm -rf $version

if [ ! -e $archive ]; then
    wget -O $archive $url
fi

tar xzvf $archive

pushd $version
./configure --prefix="$prefix" \
            --sbin-path="$prefix/bin" \
            --with-http_ssl_module \
            --without-http_scgi_module \
            --without-http_ssi_module \
            --add-module="${module_root}/ngx_devel_kit-0.2.19" \
            --add-module="${module_root}/ngx_http_set_hash-0.2.1" \
            --add-module="${module_root}/echo-nginx-module-0.55" \
            --add-module="${module_root}/vkholodkov-nginx-upload-module-2.2-ed996c4f7f"
make build
make install
popd

rm -rf $version
rm -rf $archive

