#!/bin/bash


set -e

name=
tag=
nginx_prefix=
noclobber=
args=

while [ $# -gt 0 ]; do

    case $1 in

	    --name=*)
		name=${1#--name=}
	    ;;

	    --tag=*)
		tag=${1#--tag=}
	    ;;

	    --nginx-prefix=*)
		nginx_prefix=${1#--nginx-prefix=}
	    ;;

	    --noclobber=*)
		noclobber=${1#--noclobber=}
	    ;;

	    *)
		args="$args $1"
	    ;;

    esac

    shift

done


tag="$name:$tag"
noclobber=$(echo $noclobber | tr '[:upper:]' '[:lower:]')
noclobber=${noclobber:-true}

. ../etc/docker/common.sh

if [ "$(exists $1)" = "y" ]; then
    if [ "$noclobber" = "true" ]; then
        echo "Image '$tag' exists"
        exit 1
    fi
    if [ "$noclobber" = "false" ]; then
	rmi $tag
    else
        echo "Parameter value error - expected 'true' or 'false', got '$noclobber'"
        exit 1
    fi
fi


mkdir -p src
rm -rf src/nginx
cp -r $nginx_prefix src/nginx

cat > src/Dockerfile <<EOF

# Generated Dockerfile - do not edit!

FROM ubuntu:14.04

ENV DEBIAN_FRONTEND noninteractive

RUN apt-get -y update
RUN apt-get -y install uwsgi

COPY nginx $nginx_prefix

EOF

docker build --tag=$tag --force-rm src

