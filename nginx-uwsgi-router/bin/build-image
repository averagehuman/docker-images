#!/bin/bash


set -e

name=
tag=
nginx_prefix=
args=

while [ $# -gt 0 ]; do

    case $1 in

	    --name=*)
		name=${1#--name=}
	    ;;

	    --tag=*)
		tag=${1#--tag=}
	    ;;

	    --nginx-prefix=*)
		nginx_prefix=${1#--nginx-prefix=}
	    ;;

	    *)
		args="$args $1"
	    ;;

    esac

    shift

done

if [ ! $name ]; then echo "--name is required"; exit 1; fi
if [ ! $nginx_prefix ]; then echo "--nginx-prefix is required"; exit 1; fi


if [ $tag ]; then
    name="$name:$tag"
fi

. ../etc/docker/common.sh


if [ $(image_exists "$name") -ne 0 ]; then
    echo "Image '$name' exists. To delete it run 'make rmi'."
    exit 1
fi


mkdir -p src

cat > src/Dockerfile <<EOF

# Generated Dockerfile - do not edit!

FROM ubuntu:14.04

ENV DEBIAN_FRONTEND noninteractive

RUN apt-get -y update
RUN apt-get -y install python python-dev
RUN apt-get -y install supervisor

COPY nginx $nginx_prefix
COPY uwsgi /usr/local/bin/uwsgi
RUN ln -s $nginx_prefix/bin/nginx /usr/local/bin/nginx
RUN mkdir -p /var/www

COPY supervisord.conf /etc/supervisor/supervisord.conf
COPY router.conf /etc/supervisor/conf.d/programs.conf

EXPOSE 80 3030

CMD ["/usr/bin/supervisord"]

EOF

docker build --tag=$name --force-rm src

